<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>420360</title>

<!-- Social/SEO Metadata -->
<meta name="description" content="420360: 90s retro web popups, glitch art, and digital nostalgia." />
<meta property="og:title" content="420360" />
<meta property="og:description" content="90s retro web popups, glitch art, and digital nostalgia." />
<meta property="og:image" content="https://420360.xyz/assets/images/420360arcadebanner.png" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://420360.xyz/" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="420360" />
<meta name="twitter:description" content="90s retro web popups, glitch art, and digital nostalgia." />
<meta name="twitter:image" content="https://420360.xyz/assets/images/420360arcadebanner.png" />
<!-- Social links for search engines -->
<link rel="me" href="https://hey.xyz/u/wooden" />
<link rel="me" href="https://www.youtube.com/@woodenhat" />
<link rel="me" href="https://woodmurderedhat.com/social" />

<!-- Favicon: Retro smiley emoji as data URL -->
<link rel="icon" type="image/svg+xml" href="https://420360.xyz/assets/images//favicon.ico">

<!-- Pixel font -->
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
:root{
  --bg: #1a1f1a;
  --primary: #4a8c3a;
  --secondary: #7b5e8b;
  --highlight: #8fbc8f;
  --text: #e8f5e8;
  --popup-w: 250px;
  --popup-h: 150px;
}

* { box-sizing: border-box; }

html,body{
  height:100%;
  margin:0;
  padding:0;
  background:var(--bg);
  color:var(--text);
  font-family: 'Press Start 2P', 'Courier New', monospace;
  image-rendering: pixelated;
  overflow: hidden;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
}

/* Blurb / headline */
.blurb{
  font-size:18px;
  max-width:90%;
  text-align:center;
  line-height:1.7;
  letter-spacing:1.5px;
  background:var(--bg);
  border:4px solid var(--primary);
  box-shadow:
    0 0 0 4px var(--secondary),
    8px 8px 0 0 var(--highlight),
    0 0 0 8px #000;
  padding:24px 16px 16px 16px;
  z-index:2;
  user-select:none;
}
.blurb span{ display:inline-block; margin-right:6px; transition: color .2s, background .2s; }
.blurb .glitch{
  color:var(--secondary);
  background:var(--highlight);
  text-shadow:2px 2px 0 var(--primary), 0 0 1px #000;
  animation: glitchy .12s steps(2) infinite alternate;
}

/* small CRT screen glitch of the whole blurb */
.blurb.glitch-effect{ animation: screen-glitch .15s steps(2) 3; }

@keyframes glitchy{
  0%{ transform: translate(0,0); }
  20%{ transform: translate(-2px,1px); }
  40%{ transform: translate(2px,-1px); }
  60%{ transform: translate(-1px,2px); }
  80%{ transform: translate(1px,-2px); }
  100%{ transform: translate(0,0); }
}
@keyframes screen-glitch{
  0%,100%{ transform: translate(0,0); }
  25%{ transform: translate(-2px,1px); }
  50%{ transform: translate(2px,-1px); }
  75%{ transform: translate(-1px,2px); }
}

/* blinking cursor */
.cursor{
  display:inline-block;
  width:1ch;
  color:var(--primary);
  background:#000;
  font-weight:bold;
  animation: blink .8s steps(1) infinite;
  text-shadow:2px 2px 0 var(--secondary);
  vertical-align:baseline;
}
@keyframes blink{ 0%,49%{ opacity:1 } 50%,100%{ opacity:0 } }

/* Pause state (applies when page is hidden) */
.paused .blurb,
.paused .blurb .glitch,
.paused .cursor,
.paused .popup { animation-play-state: paused !important; }

/* Popup styling */
.popup{
  position:fixed;
  width:var(--popup-w);
  min-height:var(--popup-h);
  background:var(--bg);
  border:4px solid var(--secondary);
  box-shadow:
    0 0 0 4px var(--primary),
    8px 8px 0 0 var(--highlight),
    0 0 0 8px #000;
  color:var(--highlight);
  z-index:1000;
  overflow:hidden;
  opacity:0;
  transform: scale(.85) rotate(0deg);
  animation: popup-in .25s ease forwards;
  user-select:none;
}
@keyframes popup-in{
  to{ opacity:1; transform: scale(1) rotate(var(--rotation)); }
}

.titlebar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:2px 6px;
  font-size:10px;
  background:var(--secondary);
  color:var(--bg);
  border-bottom:4px solid var(--primary);
}
.titlebar .left{ display:flex; gap:6px; align-items:center; }
.titlebar img{ width:16px; height:16px; image-rendering: pixelated; }
.close{ cursor:pointer; font-size:16px; color:var(--highlight); transition: color .15s; }
.close:hover{ color:var(--secondary); }

.content{ padding:10px 8px 12px 8px; color:var(--highlight); font-size:10px; text-align:center; }
.content img{
  max-width:100%;
  border:4px solid var(--primary);
  box-shadow: 0 0 0 4px var(--secondary), 4px 4px 0 0 var(--highlight);
  image-rendering: pixelated;
}

/* accessible focus styles for links */
.content a{ color:inherit; text-decoration:underline; }
.content a:focus{ outline:2px dashed var(--primary); outline-offset:3px; }
</style>
<!-- Glitch-out disappearance animation for popups -->
<style>
@keyframes popup-glitch-out {
  0% { opacity: 1; filter: none; transform: translate(0,0) scale(1) rotate(var(--rotation)); }
  20% { opacity: 1; filter: hue-rotate(45deg) contrast(2); transform: translate(-2px, 1px) scale(1.05) rotate(var(--rotation)); }
  40% { opacity: .8; filter: hue-rotate(-45deg) contrast(3); transform: translate(2px, -1px) scale(0.95) rotate(var(--rotation)); }
  60% { opacity: .6; filter: hue-rotate(90deg) contrast(4); transform: translate(-1px, 2px) scale(1.08) rotate(var(--rotation)); }
  80% { opacity: .3; filter: hue-rotate(-90deg) contrast(0.5); transform: translate(1px, -2px) scale(0.9) rotate(var(--rotation)); }
  100% { opacity: 0; filter: none; transform: translate(0,0) scale(0.8) rotate(var(--rotation)); }
}
@keyframes popup-glitch-fade {
  0% { opacity: 1; filter: none; }
  30% { opacity: 0.7; filter: blur(1.5px) brightness(1.5); }
  60% { opacity: 0.4; filter: blur(3px) brightness(2); }
  100% { opacity: 0; filter: blur(6px) brightness(2.5); }
}
@keyframes popup-glitch-slide {
  0% { opacity: 1; transform: translate(0,0) scale(1) rotate(var(--rotation)); }
  40% { opacity: 0.7; transform: translate(-40px, 10px) scale(1.1) rotate(calc(var(--rotation) + 8deg)); }
  80% { opacity: 0.3; transform: translate(60px, -20px) scale(0.9) rotate(calc(var(--rotation) - 12deg)); }
  100% { opacity: 0; transform: translate(0,80px) scale(0.7) rotate(var(--rotation)); }
}
@keyframes popup-glitch-scale {
  0% { opacity: 1; transform: scale(1) rotate(var(--rotation)); filter: none; }
  30% { opacity: 0.8; transform: scale(1.2) rotate(calc(var(--rotation) + 10deg)); filter: contrast(2); }
  60% { opacity: 0.5; transform: scale(0.7) rotate(calc(var(--rotation) - 10deg)); filter: contrast(0.5); }
  100% { opacity: 0; transform: scale(0.3) rotate(var(--rotation)); filter: none; }
}
.popup.glitch-out {
  animation: popup-glitch-out 0.35s steps(2, jump-none) forwards;
}
.popup.glitch-fade {
  animation: popup-glitch-fade 0.45s linear forwards;
}
.popup.glitch-slide {
  animation: popup-glitch-slide 0.38s cubic-bezier(.7,-0.2,.6,1.5) forwards;
}
.popup.glitch-scale {
  animation: popup-glitch-scale 0.32s cubic-bezier(.5,1.5,.7,1) forwards;
}
</style>
</head>
<body>

<!-- === HEADER CONTROLS (Top Bar) === -->
<div id="header-controls" style="position:fixed;top:10px;left:50%;transform:translateX(-50%);display:flex;gap:14px;z-index:6000;flex-wrap:wrap;justify-content:center;">
  <div id="about-control" class="ctrl-btn" style="display:flex;align-items:center;gap:6px;font-size:10px;font-family:'Press Start 2P', monospace;background:var(--bg);border:3px solid var(--secondary);box-shadow:0 0 0 3px var(--primary),4px 4px 0 0 var(--highlight),0 0 0 6px #000;padding:6px 10px;cursor:pointer;user-select:none;" role="button" tabindex="0" title="About (A)" aria-label="About 420360">
    <span style="color:var(--highlight);text-shadow:2px 2px 0 var(--primary);">ABOUT</span>
    <span style="color:var(--secondary);">‚ÑπÔ∏è</span>
  </div>
  <div id="games-control" class="ctrl-btn" style="display:flex;align-items:center;gap:6px;font-size:10px;font-family:'Press Start 2P', monospace;background:var(--bg);border:3px solid var(--secondary);box-shadow:0 0 0 3px var(--primary),4px 4px 0 0 var(--highlight),0 0 0 6px #000;padding:6px 10px;cursor:pointer;user-select:none;" role="button" tabindex="0" title="Games Index (G)" aria-label="Open games index">
    <span style="color:var(--highlight);text-shadow:2px 2px 0 var(--primary);">GAMES</span>
    <span style="color:var(--secondary);">üïπÔ∏è</span>
  </div>
</div>
<!-- Bottom Controls: Issues (left), Music & SFX (right cluster) -->
<div id="issue-report" style="position:fixed;bottom:10px;left:10px;z-index:5000;display:flex;align-items:center;gap:6px;font-size:10px;font-family:'Press Start 2P', monospace;background:var(--bg);border:3px solid var(--secondary);box-shadow:0 0 0 3px var(--primary),4px 4px 0 0 var(--highlight),0 0 0 6px #000;padding:6px 10px;cursor:pointer;user-select:none;" role="button" tabindex="0" title="Report an issue on GitHub (I)" aria-label="Report an issue on GitHub">
  <span style="color:var(--highlight);text-shadow:2px 2px 0 var(--primary);">ISSUES</span>
  <span style="color:var(--secondary);">üêû</span>
</div>
<div id="music-control" style="position:fixed;bottom:10px;right:10px;z-index:5000;display:flex;align-items:center;gap:6px;font-size:10px;font-family:'Press Start 2P', monospace;background:var(--bg);border:3px solid var(--secondary);box-shadow:0 0 0 3px var(--primary),4px 4px 0 0 var(--highlight),0 0 0 6px #000;padding:6px 8px;cursor:pointer;user-select:none;" role="button" aria-pressed="true" tabindex="0" title="Toggle music (M)">
  <span id="music-status" style="color:var(--highlight);text-shadow:2px 2px 0 var(--primary);">MUSIC: ON</span>
  <span style="color:var(--secondary);">‚ô´</span>
</div>
<div id="sfx-control" style="position:fixed;bottom:10px;right:170px;z-index:5000;display:flex;align-items:center;gap:6px;font-size:10px;font-family:'Press Start 2P', monospace;background:var(--bg);border:3px solid var(--secondary);box-shadow:0 0 0 3px var(--primary),4px 4px 0 0 var(--highlight),0 0 0 6px #000;padding:6px 8px;cursor:pointer;user-select:none;" role="button" aria-pressed="true" tabindex="0" title="Toggle sound effects (S)">
  <span id="sfx-status" style="color:var(--highlight);text-shadow:2px 2px 0 var(--primary);">SFX: ON</span>
  <span style="color:var(--secondary);">üîä</span>
</div>
<audio id="bgMusic" preload="auto" loop style="display:none">
  <source src="assets/music/Chaos is Our Love.mp3" type="audio/mpeg" />
  <!-- Fallback text -->Your browser does not support the audio element.
</audio>
<style>
/* Music control glitch effect */
#music-control.glitching{ animation: musicGlitch .18s steps(2) 3; }
@keyframes musicGlitch{
  0%{ filter:none; transform:translate(0,0); }
  25%{ filter:hue-rotate(40deg) contrast(1.6); transform:translate(-2px,1px); }
  50%{ filter:hue-rotate(-40deg) contrast(2); transform:translate(2px,-1px); }
  75%{ filter:hue-rotate(80deg) contrast(.8); transform:translate(-1px,2px); }
  100%{ filter:none; transform:translate(0,0); }
}
</style>

<!-- Emoticon & Socials Section -->
<div id="socials-emoticons" style="margin: 18px 0 10px 0; text-align: center; z-index: 10;">
  <div style="font-size: 13px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
    <a href="https://hey.xyz/u/wooden" target="_blank" rel="noopener noreferrer" title="üòé" style="color:var(--secondary);text-decoration:none;">üëÅÔ∏è</a>
    <a href="https://www.youtube.com/@woodenhat" target="_blank" rel="noopener noreferrer" title="üïπÔ∏è" style="color:var(--highlight);text-decoration:none;">‚ñ∂Ô∏è</a>
  <a href="https://woodmurderedhat.com/social" target="_blank" rel="noopener noreferrer" title="üåê" style="color:var(--text);text-decoration:none;">üå≤</a>
  
  </div>
</div>

<div class="blurb" id="blurb" aria-live="polite"></div>

<script>
/* ========== CONFIG ========== */
/* ===== Integrated Overlays (About + Oracle) ===== */
const overlayStyles = document.createElement('style');
overlayStyles.textContent = `
  .integrated-overlay{position:fixed;top:5%;left:50%;transform:translateX(-50%);width:82vw;height:82vh;background:var(--bg);border:4px solid var(--secondary);box-shadow:0 0 0 4px var(--primary),8px 8px 0 0 var(--highlight),0 0 0 8px #000;z-index:4000;display:flex;flex-direction:column;}
  .integrated-overlay.hidden{display:none;}
  .integrated-overlay header{display:flex;align-items:center;justify-content:space-between;padding:4px 8px;font-size:10px;background:var(--secondary);color:var(--bg);border-bottom:4px solid var(--primary);}
  .integrated-overlay header span{font-size:11px;letter-spacing:1px;color:var(--highlight);text-shadow:2px 2px 0 var(--primary);}
  .integrated-overlay header button{font-family:'Press Start 2P', monospace;font-size:10px;cursor:pointer;background:var(--bg);color:var(--highlight);border:2px solid var(--primary);padding:4px 6px;}
  .integrated-overlay header button:hover{background:var(--primary);color:#000;}
  .integrated-overlay iframe{flex:1;border:0;background:#000;image-rendering:pixelated;}
  @media (max-width:900px){ .integrated-overlay{width:96vw;height:86vh;top:6%;} }
`;
document.head.appendChild(overlayStyles);

function createOverlay(id,label,src){
  if(document.getElementById(id)) return;
  const wrap = document.createElement('div');
  wrap.id = id; wrap.className = 'integrated-overlay hidden';
  wrap.innerHTML = `<header><span>${label}</span><div style="display:flex;gap:6px;">
    <button data-act="external" title="Open in new tab">‚Üó</button>
    <button data-act="reload" title="Reload">‚ü≥</button>
    <button data-act="close" title="Close">‚úï</button>
  </div></header><iframe src="${src}" loading="lazy" title="${label}"></iframe>`;
  document.body.appendChild(wrap);
  makeDraggableOverlay(wrap);
  // Button handlers with stopPropagation to avoid background clicks
  wrap.querySelector('[data-act="reload"]').addEventListener('click', e=>{ e.stopPropagation(); reloadFrame(id); });
  wrap.querySelector('[data-act="close"]').addEventListener('click', e=>{ e.stopPropagation(); closeOverlay(id); });
  wrap.querySelector('[data-act="external"]').addEventListener('click', e=>{ e.stopPropagation(); const ifr=wrap.querySelector('iframe'); if(ifr) window.open(ifr.src,'_blank','noopener'); });
}
// Ensure only one overlay visible at a time (except during close animation of old ones)
function closeAllOverlays(exceptId){
  document.querySelectorAll('.integrated-overlay:not(.hidden)').forEach(el=>{
    if(el.id===exceptId) return;
    // force-hide without animation for instant switch
    el.classList.add('hidden');
    el.classList.remove('closing');
  });
  resumeBackgroundIfNone();
}
// Add fade-out animation style once
if(!document.getElementById('overlayAnimStyle')){
  const s = document.createElement('style');
  s.id='overlayAnimStyle';
  s.textContent = `.integrated-overlay.closing{ animation: overlayFade .18s ease forwards; }
  @keyframes overlayFade { to { opacity:0; transform:translateX(-50%) scale(.96); } }`;
  document.head.appendChild(s);
}

function makeDraggableOverlay(el){
  let isDown=false,ox=0,oy=0; const header=el.querySelector('header');
  header.style.cursor='move';
  header.addEventListener('mousedown',e=>{isDown=true;ox=e.clientX - el.offsetLeft; oy=e.clientY - el.offsetTop;});
  window.addEventListener('mouseup',()=>isDown=false);
  window.addEventListener('mousemove',e=>{ if(!isDown) return; el.style.left=(e.clientX-ox)+'px'; el.style.top=(Math.max(0,e.clientY-oy))+'px'; el.style.transform='translateX(0)'; });
}

function openAbout(){ createOverlay('aboutOverlay','ABOUT ‚Ä¢ 420360','about/index.html'); showOverlay('aboutOverlay'); }
function openOracle(){ createOverlay('oracleOverlay','TIM ‚Ä¢ DIALOGUE ORACLE','games/tim-the-dialogue-oracle/index.html'); showOverlay('oracleOverlay'); }
function openGamesIndex(){ createOverlay('gamesIndexOverlay','GAMES ‚Ä¢ 420360','games/index.html'); showOverlay('gamesIndexOverlay'); }
function openGameOverlay(label, url){
  // Normalize internal absolute URLs to relative
  const rel = url.replace(/^https?:\/\/420360\.xyz\//,'');
  // Single reusable game overlay
  let el = document.getElementById('gameOverlay');
  if(!el){
    createOverlay('gameOverlay', label, rel);
    el = document.getElementById('gameOverlay');
  } else {
    // update label and iframe
    const headerSpan = el.querySelector('header span');
    if(headerSpan) headerSpan.textContent = label.toUpperCase();
    const iframe = el.querySelector('iframe');
    if(iframe) iframe.src = rel;
  }
  showOverlay('gameOverlay');
}
function openContentOverlay(label, url){
  const elId = 'contentOverlay';
  let el = document.getElementById(elId);
  if(!el){
    createOverlay(elId, label, url);
    el = document.getElementById(elId);
  } else {
    const headerSpan = el.querySelector('header span');
    if(headerSpan) headerSpan.textContent = label.toUpperCase();
    const iframe = el.querySelector('iframe');
    if(iframe) iframe.src = url;
  }
  showOverlay(elId);
}
function showOverlay(id){
  const el = document.getElementById(id);
  if(!el) return;
  closeAllOverlays(id);
  el.classList.remove('hidden');
  // move to end of DOM so stacking order stays intuitive
  document.body.appendChild(el);
  el.focus();
  pauseBackground();
}
function closeOverlay(id){
  const el=document.getElementById(id);
  if(!el || el.classList.contains('hidden') || el.classList.contains('closing')) return;
  el.classList.add('closing');
  // After animation, hide
  setTimeout(()=>{ el.classList.add('hidden'); el.classList.remove('closing'); resumeBackgroundIfNone(); }, 190);
}
function reloadFrame(id){ const el=document.getElementById(id); if(!el) return; const ifr=el.querySelector('iframe'); ifr.src=ifr.src; }

function pauseBackground(){ stopIntervals(); }
function resumeBackgroundIfNone(){ const anyOpen = document.querySelectorAll('.integrated-overlay:not(.hidden)').length>0; if(!anyOpen) startIntervals(); }

// Keyboard shortcut: press A for About, O for Oracle (when not typing inside overlays)
window.addEventListener('keydown',e=>{ if(e.target.tagName==='INPUT'|| e.target.tagName==='TEXTAREA') return; if(e.key==='a'||e.key==='A'){ openAbout(); } if(e.key==='g'||e.key==='G'){ openGamesIndex(); } if(e.key==='o'||e.key==='O'){ openOracle(); } if(e.key==='Escape'){ document.querySelectorAll('.integrated-overlay:not(.hidden)').forEach(el=>closeOverlay(el.id)); } });

// Intercept clicks on any popup link to open in overlay (internal or external)
document.addEventListener('click', (e)=>{
  const a = e.target.closest('.popup a');
  if(!a) return;
  const href = a.getAttribute('href')||'';
  if(!href) return;
  // Oracle special
  if(href === '__INTERNAL_ORACLE__'){ e.preventDefault(); openOracle(); return; }
  // Blocklist: let these open in new tab (X-Frame-Options / CSP issues)
  const OVERLAY_BLOCKLIST = [/youtube\.com/i, /youtu\.be/i, /discord\.gg/i, /giphy\.com/i];
  if (OVERLAY_BLOCKLIST.some(r => r.test(href))) {
    // Ensure it opens in a new tab
    a.setAttribute('target','_blank');
    return; // do not preventDefault; allow normal navigation
  }
  e.preventDefault();
  let label = 'LINK';
  const popup = a.closest('.popup');
  if(popup){ const span = popup.querySelector('.titlebar span'); if(span) label = span.textContent.trim(); }
  if(/420360\.xyz\/games\//.test(href) || /^games\//.test(href)){
    openGameOverlay(label + ' ‚Ä¢ 420360', href);
  } else if(/\/games\//.test(href)) {
    openGameOverlay(label + ' ‚Ä¢ 420360', href);
  } else {
    openContentOverlay(label + ' ‚Ä¢ EXT', href);
  }
});

// PostMessage API: allow embedded pages (games index) to request opening a game
window.addEventListener('message', (event)=>{
  try{
    const data = event.data;
    if(!data || typeof data !== 'object') return;
    if(data.type === 'open-game' && data.url){
      const label = (data.label || 'GAME') + ' ‚Ä¢ 420360';
      openGameOverlay(label, data.url);
    }
    if(data.type === 'close-overlay' && data.id){
      closeOverlay(data.id);
    }
  }catch(err){ /* ignore */ }
});

const ICON_DATA = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAAALklEQVQoka3OMQ0AAAzDsPnfpM1Yip5JRGCBqgMFBQUFBQUFBQUFBQUFBSUlG8mG6tD3oxAAAAAElFTkSuQmCC";

// NOTE: All GIFs below must originate from the woodmurderedhat Giphy channel per project policy.
// Curated list of known woodmurderedhat GIF IDs (can expand as more are uploaded):
// 3PLAXg1osLVVttjRTN, WveGOgFwcI6uTn2khE, eYDnuFt0MckAb3xdSH, DfqSbJVYLHmO8QFn1R,
// 7Ti0iZdo5QCiWJfMvA, qxJ9pAQCBIJLxfelCv, HtCcDJ134eAICJZjLb, JeEjGpM2TVZGaM5BuE
const ADS = [
  { label: "ZEF VIBES", href: "https://discord.gg/zef", gif: "https://media.giphy.com/media/eYDnuFt0MckAb3xdSH/giphy.gif" },
  { label: "TETROMINO", href: "https://420360.xyz/games/tarot-tetromino/index.html", gif: "https://media.giphy.com/media/3PLAXg1osLVVttjRTN/giphy.gif" },
  { label: "GLITCH MAZE", href: "https://420360.xyz/games/glitch-maze/index.html", gif: "https://media.giphy.com/media/7Ti0iZdo5QCiWJfMvA/giphy.gif" },
  { label: "NEON SIMON", href: "https://420360.xyz/games/neon-simon/index.html", gif: "https://media.giphy.com/media/DfqSbJVYLHmO8QFn1R/giphy.gif" },
  { label: "PIXEL RAIN", href: "https://420360.xyz/games/pixel-rain/index.html", gif: "https://media.giphy.com/media/qxJ9pAQCBIJLxfelCv/giphy.gif" },
  { label: "SNAKE GAME", href: "https://420360.xyz/games/snake/index.html", gif: "https://media.giphy.com/media/WveGOgFwcI6uTn2khE/giphy.gif" },
  { label: "PONG CLASSIC", href: "https://420360.xyz/games/pong/index.html", gif: "https://media.giphy.com/media/HtCcDJ134eAICJZjLb/giphy.gif" },
  { label: "MEMORY CARDS", href: "https://420360.xyz/games/memory/index.html", gif: "https://media.giphy.com/media/JeEjGpM2TVZGaM5BuE/giphy.gif" },
  { label: "BREAKOUT", href: "https://420360.xyz/games/breakout/index.html", gif: "https://media.giphy.com/media/eYDnuFt0MckAb3xdSH/giphy.gif" },
  { label: "GENERATIVE ART", href: "https://420360.xyz/games/generative-art/index.html", gif: "https://media.giphy.com/media/3PLAXg1osLVVttjRTN/giphy.gif" },
  { label: "NOCTIS REVERIE", href: "https://420360.xyz/games/noctis-reverie/index.html", gif: "https://media.giphy.com/media/7Ti0iZdo5QCiWJfMvA/giphy.gif" },
  { label: "247420", href: "https://discord.gg/an-entrypoint-367741339393327104", gif: "https://media.giphy.com/media/DfqSbJVYLHmO8QFn1R/giphy.gif" },
  { label: "GIPHY", href: "https://giphy.com/woodmurderedhat", gif: "https://media.giphy.com/media/qxJ9pAQCBIJLxfelCv/giphy.gif" },
  { label: "WOODMURDEREDHAT", href: "https://woodmurderedhat.com/social", gif: "https://media.giphy.com/media/HtCcDJ134eAICJZjLb/giphy.gif" },
  { label: "YOUTUBE", href: "https://www.youtube.com/@woodenhat", gif: "https://media.giphy.com/media/JeEjGpM2TVZGaM5BuE/giphy.gif" },
  { label: "FRIDAY", href: "#", gif: "https://media.giphy.com/media/3PLAXg1osLVVttjRTN/giphy.gif" },
  { label: "SATURDAY", href: "#", gif: "https://media.giphy.com/media/WveGOgFwcI6uTn2khE/giphy.gif" },
  { label: "PEARL WHAT?", href: "https://www.youtube.com/watch?v=DXS6NbEAkLM", gif: "https://media.giphy.com/media/eYDnuFt0MckAb3xdSH/giphy.gif" },
  { label: "ZEF SHELLED#", href: "#", gif: "https://media.giphy.com/media/7Ti0iZdo5QCiWJfMvA/giphy.gif" },
  { label: "MOAN-AH", href: "https://www.youtube.com/watch?v=wo5QBEux8nk", gif: "https://media.giphy.com/media/DfqSbJVYLHmO8QFn1R/giphy.gif" },
  { label: "WEDNESDAY", href: "#", gif: "https://media.giphy.com/media/qxJ9pAQCBIJLxfelCv/giphy.gif" },
  { label: "WAR ART", href: "#", gif: "https://media.giphy.com/media/HtCcDJ134eAICJZjLb/giphy.gif" },
  { label: "ZEF DEMONS", href: "#", gif: "https://media.giphy.com/media/JeEjGpM2TVZGaM5BuE/giphy.gif" },
  { label: "HEY ON LENS", href: "https://hey.xyz/u/wooden", gif: "https://media.giphy.com/media/3PLAXg1osLVVttjRTN/giphy.gif" },
  { label: "SHADOW PROTOCOL", href: "https://420360.xyz/null-vesper/shadow-protocol/", gif: "https://media.giphy.com/media/7Ti0iZdo5QCiWJfMvA/giphy.gif"},
  { label: "TIM ORACLE", href: "__INTERNAL_ORACLE__", gif: "https://media.giphy.com/media/qxJ9pAQCBIJLxfelCv/giphy.gif" }
];

const POPUP_INTERVAL_MS = 1000;    // auto spawn interval
const POPUP_LIFETIME_MS = 9500;  // how long each popup lives (ms)
const MAX_POPUPS = 200;             // hard cap to avoid memory bloat
const NON_OVERLAP_ATTEMPTS = 30;   // tries to find non-overlapping placement
// Reduced motion support: if user prefers reduced motion, slow things down & lower counts
const REDUCED_MOTION = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
// Dynamic interval overrides (can't reassign consts above, so we branch when starting intervals)
const POPUP_INTERVAL_REDUCED = 4000;
const GLITCH_INTERVAL_DEFAULT = 200;
const GLITCH_INTERVAL_REDUCED = 1000;
const MORPH_INTERVAL_DEFAULT = 2500;
const MORPH_INTERVAL_REDUCED = 6000;

const SENTENCES = [
  "Welcome to the future of the internet ",
  "Surf the web like it‚Äôs 1996 ",
  "Pixels were our stars in the night sky ",
  "Error 404: meaning not found ",
  "The modem‚Äôs hum was a lullaby for the lost ",
  "Reality pixelated in low-res confusion ",
  "The cursor blinks, waiting for meaning ",
  "Lost in the metadata of my own mind ",
  "The blue screen of existential dread ",
  "Loading life in 8-bit resolution ",
  "Dial-up dreams in a broadband world ",
  "My heart beats in ASCII code ",
  "Pop-ups were portals to the unknown ",
  "Neon hyperlinks light the way home ",
  "Buffering thoughts in a digital haze ",
  "Chatrooms echo with forgotten voices ",
  "The web was wild, untamed, infinite ",
  "Caffeine and code at 3AM ",
  "My soul uploads at 56k speeds ",
  "Lost packets, lost memories ",
  "The homepage is where the heart is ",
  "Right-click to save nostalgia ",
  "Pop culture in pop-up windows ",
  "The night glows with CRT static ",
  "We surfed the chaos, byte by byte ",
  "404: Sleep not found ",
  "My dreams are animated GIFs ",
  "The internet never forgets a meme ",
  "Reality checks in Comic Sans ",
  "I left my heart in a guestbook "
];

/* ========== PRELOAD GIFS ========== */
ADS.forEach(a => { const i = new Image(); i.src = a.gif; });

/* ========== DOM REFS ========== */
const blurbEl = document.getElementById('blurb');
let currentSentence = SENTENCES[0];

/* ========== BLURB TEXT + GLITCH ========= */
function setBlurbText(sentence){
  blurbEl.innerHTML = "";
  const words = sentence.trim().split(" ").filter(Boolean);
  words.forEach(w => {
    const s = document.createElement('span');
    s.textContent = w;
    blurbEl.appendChild(s);
  });
  const cursor = document.createElement('span');
  cursor.className = 'cursor';
  cursor.textContent = '_';
  blurbEl.appendChild(cursor);
}
setBlurbText(currentSentence);

function randomGlitchString(len){
  const chars = "!@#$%^&*()_+=-[]{};:<>,.?/|~420360";
  return Array.from({length:len}, ()=>chars.charAt(Math.floor(Math.random()*chars.length))).join('');
}

function glitchRandomWord(){
  const spans = blurbEl.querySelectorAll('span:not(.cursor)');
  if (!spans.length) return;
  // rare chance for whole-blurb glitch
  if (Math.random() < 0.02) fullGlitch();

  // pick a word and briefly replace it with gibberish
  const idx = Math.floor(Math.random()*spans.length);
  const span = spans[idx];
  if (!span || span.classList.contains('glitch')) return;
  const original = span.textContent;
  span.textContent = randomGlitchString(Math.max(1, original.length));
  span.classList.add('glitch');
  setTimeout(()=> {
    span.textContent = original;
    span.classList.remove('glitch');
  }, 120 + Math.random()*300);
}

function fullGlitch(){
  blurbEl.classList.add('glitch-effect');
  setTimeout(()=> blurbEl.classList.remove('glitch-effect'), 300);
}

function morphToRandomSentence() {
  const currentTrimmed = currentSentence.trim();
  const uniqueSentences = SENTENCES.filter(s => s.trim() !== currentTrimmed);
  if (uniqueSentences.length === 0) return;

  let nextSentence = uniqueSentences[Math.floor(Math.random() * uniqueSentences.length)];

  const currentWords = currentSentence.trim().split(" ");
  const targetWords = nextSentence.trim().split(" ");
  const maxLength = Math.max(currentWords.length, targetWords.length);

  let spans = blurbEl.querySelectorAll('span:not(.cursor)');
  // Add spans if needed
  while (spans.length < maxLength) {
    const span = document.createElement('span');
    span.style.marginRight = "6px";
    blurbEl.insertBefore(span, blurbEl.querySelector('.cursor'));
    spans = blurbEl.querySelectorAll('span:not(.cursor)');
  }
  // Remove extra spans if target sentence shorter
  if (spans.length > maxLength) {
    for (let i = spans.length - 1; i >= maxLength; i--) {
      spans[i].remove();
    }
    spans = blurbEl.querySelectorAll('span:not(.cursor)');
  }

  let changeOrder = Array.from({length: maxLength}, (_, i) => i);
  changeOrder.sort(() => Math.random() - 0.5);

  let step = 0;
  function changeNextWord() {
    if (step >= changeOrder.length) {
      currentSentence = nextSentence;
      return;
    }
    const idx = changeOrder[step];
    const newWord = targetWords[idx] || "";
    spans[idx].textContent = newWord;
    step++;
    setTimeout(changeNextWord, 150);
  }
  changeNextWord();
}

/* ========== POPUP MANAGEMENT ========== */
const activePopups = []; // FIFO list of DOM elements currently on-screen (or recently added)

/* helper: does a candidate rect overlap an existing popup element? */
function rectsOverlap(x, y, w, h, el){
  const r = el.getBoundingClientRect();
  return !(x + w < r.left || x > r.right || y + h < r.top || y > r.bottom);
}

/* try to find a non-overlapping x,y; returns px,py in px */
function findNonOverlappingPosition(attempts = NON_OVERLAP_ATTEMPTS){
  const w = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--popup-w')) || 250;
  const h = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--popup-h')) || 150;
  const maxX = Math.max(0, window.innerWidth - w);
  const maxY = Math.max(0, window.innerHeight - h);

  for (let i=0;i<attempts;i++){
    const x = Math.floor(Math.random() * (maxX+1));
    const y = Math.floor(Math.random() * (maxY+1));
    let collides = false;
    for (const existing of activePopups){
      // some existing popups may have been removed; skip those
      if (!existing || !existing.getBoundingClientRect) continue;
      if (rectsOverlap(x, y, w, h, existing)) { collides = true; break; }
    }
    if (!collides) return {x,y};
  }
  // give up, return a random position
  return { x: Math.floor(Math.random() * (maxX+1)), y: Math.floor(Math.random() * (maxY+1)) };
}

/* remove element safely and update activePopups list */
function removePopupElement(el){
  if (!el) return;
  const idx = activePopups.indexOf(el);
  if (idx !== -1) activePopups.splice(idx,1);
  if (el.parentNode) el.parentNode.removeChild(el);
}

/* create and append a popup element, returns element */
function makePopup(ad){
  const p = document.createElement('div');
  p.className = 'popup';
  // rotation + tiny scale randomization for chaotic aesthetic
  const rotation = (Math.random()*12 - 6).toFixed(2) + 'deg';
  const scale = (1 + (Math.random()*0.08 - 0.04)).toFixed(3);
  p.style.setProperty('--rotation', rotation);
  p.style.transform = `scale(${scale}) rotate(${rotation})`;

  // Random color scheme selection - red, yellow, green, black
  const colorSchemes = [
    { // Red scheme
      bg: '#2a1a1a',
      primary: '#cc3333',
      secondary: '#8b2635',
      highlight: '#ff6666'
    },
    { // Yellow scheme
      bg: '#2a2a1a',
      primary: '#cccc33',
      secondary: '#8b8b35',
      highlight: '#ffff66'
    },
    { // Green scheme
      bg: '#1a2a1a',
      primary: '#4a8c3a',
      secondary: '#7b5e8b',
      highlight: '#8fbc8f'
    },
    { // Black scheme
      bg: '#1a1a1a',
      primary: '#666666',
      secondary: '#444444',
      highlight: '#cccccc'
    }
  ];
  
  const selectedScheme = colorSchemes[Math.floor(Math.random() * colorSchemes.length)];
  
  // Apply the selected color scheme to this popup
  p.style.setProperty('--bg', selectedScheme.bg);
  p.style.setProperty('--primary', selectedScheme.primary);
  p.style.setProperty('--secondary', selectedScheme.secondary);
  p.style.setProperty('--highlight', selectedScheme.highlight);

  // position (attempt to avoid overlap)
  const pos = findNonOverlappingPosition();
  p.style.left = pos.x + 'px';
  p.style.top = pos.y + 'px';

  // content
  p.innerHTML = `
    <div class="titlebar" role="presentation">
      <div class="left">
        <img src="${ICON_DATA}" alt="" aria-hidden="true">
        <span>${escapeHtml(ad.label)}</span>
      </div>
      <div class="close" role="button" aria-label="Close popup" tabindex="0">√ó</div>
    </div>
    <div class="content">
  <a href="${escapeHtml(ad.href)}" target="_blank" rel="noopener noreferrer" data-ad-link>
        <img src="${escapeHtml(ad.gif)}" alt="${escapeHtml(ad.label)} animation">
      </a>
    </div>
  `;

  // close handlers
  const closeBtn = p.querySelector('.close');
  closeBtn.addEventListener('click', ()=> removePopupElement(p));
  closeBtn.addEventListener('keydown', (ev)=> { if(ev.key==='Enter' || ev.key===' ') { ev.preventDefault(); removePopupElement(p); } });

  document.body.appendChild(p);
  // Internal oracle override
  const link = p.querySelector('[data-ad-link]');
  if (ad.href === '__INTERNAL_ORACLE__' && link) {
    link.removeAttribute('target');
    link.addEventListener('click', (e)=>{ e.preventDefault(); openOracle(); });
  }
  activePopups.push(p);

  // schedule lifetime removal
  const lifetimeTimer = setTimeout(()=>{
    // if still present, remove it
    removePopupElement(p);
    clearTimeout(lifetimeTimer);
  }, POPUP_LIFETIME_MS);

  // enforce MAX_POPUPS
  if (activePopups.length > MAX_POPUPS){
    // remove oldest until length <= MAX_POPUPS
    while (activePopups.length > MAX_POPUPS){
      const old = activePopups.shift();
      if (old && old.parentNode) old.parentNode.removeChild(old);
    }
  }

  return p;
}

/* utility to escape user-supplied strings in markup to avoid injection */
function escapeHtml(s){
  if (typeof s !== 'string') return '';
  return s.replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
}

/* ========== SPAWN CONTROL ========== */
function randomAd(){ return ADS[Math.floor(Math.random()*ADS.length)]; }
function spawnPopup(){
  const p = makePopup(randomAd());
  if(window.playAdSfx) window.playAdSfx();
  return p;
}

/* ========== INTERVALS & PAUSE/RESUME ========== */
let popupIntervalId = null;
let glitchIntervalId = null;
let morphIntervalId = null;

// start repeated tasks if not already running
function startIntervals(){
  const popupDelay = REDUCED_MOTION ? POPUP_INTERVAL_REDUCED : POPUP_INTERVAL_MS;
  const glitchDelay = REDUCED_MOTION ? GLITCH_INTERVAL_REDUCED : GLITCH_INTERVAL_DEFAULT;
  const morphDelay = REDUCED_MOTION ? MORPH_INTERVAL_REDUCED : MORPH_INTERVAL_DEFAULT;
  if (!popupIntervalId && popupDelay > 0) popupIntervalId = setInterval(spawnPopup, popupDelay);
  if (!glitchIntervalId && glitchDelay > 0) glitchIntervalId = setInterval(glitchRandomWord, glitchDelay);
  if (!morphIntervalId && morphDelay > 0) morphIntervalId = setInterval(morphToRandomSentence, morphDelay);
  document.documentElement.classList.remove('paused');
}

// stop repeated tasks
function stopIntervals(){
  if (popupIntervalId){ clearInterval(popupIntervalId); popupIntervalId = null; }
  if (glitchIntervalId){ clearInterval(glitchIntervalId); glitchIntervalId = null; }
  if (morphIntervalId){ clearInterval(morphIntervalId); morphIntervalId = null; }
  // pause CSS animations
  document.documentElement.classList.add('paused');
}

/* handle visibility change to pause heavy activity when page not visible */
document.addEventListener('visibilitychange', ()=> {
  if (document.hidden) stopIntervals();
  else startIntervals();
});

// also pause when page is being unloaded / pagehide (mobile)
window.addEventListener('pagehide', ()=> stopIntervals());
window.addEventListener('pageshow', ()=> { if (!document.hidden) startIntervals(); });

/* ========== INITIAL BOOT ========== */
// initial intervals start only when page visible
if (!document.hidden) startIntervals();

// immediate spawn on first load for effect
// spawnPopup();

/* also allow click to spawn (debounced slightly to avoid accidental drag-spam) */
let lastClick = 0;
document.addEventListener('click', (ev)=>{
  const now = Date.now();
  // Skip spawning if click is inside an integrated overlay (About / Oracle / Game)
  if (ev.target.closest('.integrated-overlay')) return;
  if (now - lastClick > 120) { spawnPopup(); lastClick = now; }
});

// Issue report button behavior
(()=>{
  const issueBtn = document.getElementById('issue-report');
  const issueUrl = 'https://github.com/woodmurderedhat/420360/issues/new/choose';
  function openIssues(){ window.open(issueUrl,'_blank','noopener'); }
  issueBtn.addEventListener('click', e=>{ e.stopPropagation(); openIssues(); });
  issueBtn.addEventListener('keydown', e=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); openIssues(); }});
  // Keyboard shortcut (I)
  window.addEventListener('keydown', e=>{ if(e.key==='i' || e.key==='I'){ openIssues(); }});
})();
// About & Games buttons behavior
(()=>{
  const aboutBtn = document.getElementById('about-control');
  const gamesBtn = document.getElementById('games-control');
  if(aboutBtn){
    const act = ()=>{ openAbout(); };
    aboutBtn.addEventListener('click', e=>{ e.stopPropagation(); act(); });
    aboutBtn.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); act(); }});
  }
  if(gamesBtn){
    const actG = ()=>{ openGamesIndex(); };
    gamesBtn.addEventListener('click', e=>{ e.stopPropagation(); actG(); });
    gamesBtn.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); actG(); }});
  }
})();

</script>
<script>
// === MUSIC SYSTEM (deferred start after load, graceful autoplay, periodic glitch) ===
(()=>{
  const audio = document.getElementById('bgMusic');
  const ctrl = document.getElementById('music-control');
  const status = document.getElementById('music-status');
  // Start disabled: user must explicitly enable (ignores prior sessions until click)
  let userEnabled = false;
  let attempting = false;  // prevent repeat rapid attempts
  let ready = false;       // set when canplaythrough

  function updateUI(){
    const on = !audio.paused && !audio.ended;
    status.textContent = 'MUSIC: ' + (on ? 'ON' : 'OFF');
    ctrl.setAttribute('aria-pressed', String(on));
  }

  function fadeTo(targetVol, ms=1200){
    const steps = 30; const start = audio.volume; const delta = targetVol - start;
    let i=0; clearInterval(audio._fadeInt);
    audio._fadeInt = setInterval(()=>{
      i++; audio.volume = Math.min(1, Math.max(0, start + delta * (i/steps)));
      if(i>=steps){ clearInterval(audio._fadeInt); }
    }, ms/steps);
  }

  async function playMusic(){
    if(attempting) return; attempting = true;
    try{
      audio.volume = 0; // start silent, then fade
      await audio.play();
      fadeTo(0.65, 1800);
      userEnabled = true;
    }catch(err){
      // Autoplay likely blocked; wait for explicit user interaction
    }finally{ attempting = false; updateUI(); }
  }
  function stopMusic(){ audio.pause(); updateUI(); }

  function toggleMusic(){
    if(audio.paused){
      userEnabled = true;
      playMusic();
      localStorage.setItem('musicEnabled','true');
    } else {
      userEnabled = false;
      stopMusic();
      localStorage.setItem('musicEnabled','false');
    }
  }

  // First user gesture -> attempt autoplay if not yet enabled
  function firstGesture(){
    if(userEnabled && audio.paused){ playMusic(); }
    window.removeEventListener('click', firstGesture);
    window.removeEventListener('keydown', firstGesture);
  }
  window.addEventListener('click', firstGesture, { once:false });
  window.addEventListener('keydown', firstGesture, { once:false });

  // Control interactions
  ctrl.addEventListener('click', e=>{ e.stopPropagation(); toggleMusic(); });
  ctrl.addEventListener('keydown', e=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggleMusic(); }});
  window.addEventListener('keydown', e=>{ if(e.key==='m' || e.key==='M'){ toggleMusic(); }});

  // Pause when page hidden, resume if user enabled and not manually paused
  document.addEventListener('visibilitychange', ()=>{
    if(document.hidden){ if(!audio.paused) audio._wasPlaying=true; audio.pause(); }
    else if(audio._wasPlaying && userEnabled){ audio.play().catch(()=>{}); }
    if(!document.hidden) audio._wasPlaying = false;
    updateUI();
  });

  // Normalize/encode src (spaces) & begin loading
  if(!audio.getAttribute('data-src-set')){
    const srcTag = audio.querySelector('source');
    if(srcTag){ const raw = srcTag.getAttribute('src'); if(raw) audio.src = encodeURI(raw); audio.setAttribute('data-src-set','1'); }
  }
  try{ audio.load(); }catch(e){}

  audio.addEventListener('canplaythrough', ()=>{ ready = true; if(userEnabled) playMusic(); }, { once:true });
  audio.addEventListener('error', ()=>{ // retry load lightly
    setTimeout(()=>{ if(!ready) { try{ audio.load(); }catch(e){} } }, 1800);
  });

  // Fallback timed attempt if canplaythrough slow / not fired
  setTimeout(()=>{ if(userEnabled && !ready && audio.paused) playMusic(); }, 2500);
  updateUI();

  // Periodic random glitch for the music button
  function glitchMusicBtn(){
    if(ctrl.classList.contains('glitching')) return;
    ctrl.classList.add('glitching');
    setTimeout(()=>ctrl.classList.remove('glitching'), 260);
  }
  setInterval(()=>{ if(Math.random()<0.33) glitchMusicBtn(); }, 2400);
  // Save preference whenever state visibly changes (debounced via requestAnimationFrame)
  // No mutation observer needed; persistence handled on toggle only.
})();
// === END MUSIC SYSTEM ===
// === POPUP SFX SYSTEM (varied random spawn sounds) ===
(()=>{
  const ctrl = document.getElementById('sfx-control');
  const status = document.getElementById('sfx-status');
  // Start disabled: user must explicitly enable SFX each load (do not auto-play)
  let sfxEnabled = false;
  let lastPlay = 0;
  const volume = 0.55;
  const MIN_INTERVAL = 90; // ms throttle
  const SFX_FILES = [
    'BreakBeat_Slice01.wav','BreakBeat_Slice02.wav','BreakBeat_Slice03.wav','BreakBeat_Slice04.wav',
    'Clap02.wav','Clap03.wav','Clap04.wav','Clap05.wav','Clap06.wav'
  ];
  // Preload base audio elements
  const pool = SFX_FILES.map(f=>{ const a=new Audio('assets/sounds/'+f); a.preload='auto'; return a; });

  function updateUI(){
    status.textContent = 'SFX: ' + (sfxEnabled ? 'ON' : 'OFF');
    ctrl.setAttribute('aria-pressed', String(sfxEnabled));
  }

  function play(){
    if(!sfxEnabled) return;
    const now = Date.now();
    if(now - lastPlay < MIN_INTERVAL) return; // throttle overlapping spam
    lastPlay = now;
    const base = pool[Math.floor(Math.random()*pool.length)];
    try{
      // Clone for concurrent playback without cutting off tail
      const inst = base.cloneNode();
      inst.volume = volume * (0.85 + Math.random()*0.3); // slight random loudness
      // Tiny random detune by playbackRate (¬±5%) for variety
      inst.playbackRate = 0.95 + Math.random()*0.1;
      inst.play().catch(()=>{});
      // Clean up when ended (browser GC handles but explicit just in case)
      inst.addEventListener('ended', ()=>{ /* no-op */ }, { once:true });
    }catch(e){}
  }

  function toggle(){ sfxEnabled = !sfxEnabled; updateUI(); localStorage.setItem('sfxEnabled', String(sfxEnabled)); }
  ctrl.addEventListener('click', e=>{ e.stopPropagation(); toggle(); });
  ctrl.addEventListener('keydown', e=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggle(); }});
  window.addEventListener('keydown', e=>{ if(e.key==='s' || e.key==='S'){ toggle(); }});
  // Persist SFX preference on change
  // Persistence integrated into toggle; no extra listeners required.

  // Prime: try silent play for each to reduce latency later
  const prime = ()=>{
    pool.forEach(a=>{
      try{
        a.muted = true;
        a.play().then(()=>{ a.pause(); a.currentTime = 0; a.muted = false; }).catch(()=>{});
      }catch(e){}
    });
    window.removeEventListener('click', prime);
    window.removeEventListener('keydown', prime);
  };
  window.addEventListener('click', prime);
  window.addEventListener('keydown', prime);

  updateUI();
  window.playAdSfx = play; // expose globally
})();
// === END POPUP SFX SYSTEM ===
/* existing code below ... */
// Glitch-out disappearance for random popups with multiple effects
function randomPopupGlitchOut(){
  if (!activePopups.length) return;
  const popup = activePopups[Math.floor(Math.random()*activePopups.length)];
  if (!popup) return;
  // Pick a random effect
  const effects = [
    { cls: 'glitch-out', dur: 400 },
    { cls: 'glitch-fade', dur: 500 },
    { cls: 'glitch-slide', dur: 420 },
    { cls: 'glitch-scale', dur: 350 }
  ];
  // Don't apply if already glitching out
  if (effects.some(e => popup.classList.contains(e.cls))) return;
  const effect = effects[Math.floor(Math.random()*effects.length)];
  popup.classList.add(effect.cls);
  setTimeout(() => removePopupElement(popup), effect.dur);
}

// Run every ~12‚Äì120 seconds for randomness
setInterval(() => {
  if (Math.random() < 0.5) randomPopupGlitchOut();
}, 4500 + Math.random()*6000);

// Accessibility: add aria-labels to dynamically created overlay buttons (delegated once DOM ready)
document.addEventListener('DOMContentLoaded', ()=>{
  document.body.addEventListener('click', (e)=>{
    // no-op; ensures delegation binding present
  });
  
  // Add subtle randomization to weed colors
  const weedColorVariants = [
    { primary: '#4a8c3a', secondary: '#7b5e8b', highlight: '#8fbc8f' }, // default
    { primary: '#3e7b2e', secondary: '#6b4d7b', highlight: '#7daf7d' }, // darker green
    { primary: '#569946', secondary: '#8b6b9b', highlight: '#9bcf9b' }, // lighter green
    { primary: '#2d5a2d', secondary: '#5e3a6e', highlight: '#6d8e6d' }, // forest
    { primary: '#4d7a3d', secondary: '#7a5a8a', highlight: '#8aaa8a' }  // earthy
  ];
  
  // Randomly select colors with 30% chance on page load
  if (Math.random() < 0.3) {
    const variant = weedColorVariants[Math.floor(Math.random() * weedColorVariants.length)];
    const root = document.documentElement;
    root.style.setProperty('--primary', variant.primary);
    root.style.setProperty('--secondary', variant.secondary);
    root.style.setProperty('--highlight', variant.highlight);
  }
});
</script>
</body>
</html>
